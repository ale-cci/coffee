#!/usr/bin/env bash
COFFEE_EXE="./coffee"
COFFEE_BIN=${COFEE_BIN:-$HOME/.coffee}

case $1 in
    clean)
        rm -rf *.ll *.s run *.out *.dSYM
        ;;

    test)
        TEST_EXE="${COFFEE_EXE}_test"
        "$COFFEE_EXE" main.bn && mv out "${TEST_EXE}"
        find . -name '*.test.bn' -exec sh -c "echo && ${TEST_EXE} {} && ./out " \;
        rm -rf ./out "${TEST_EXE}"
        ;;


    test:watch)
        echo "Watchig for file changes..."
        fswatch --include='.bn$' --exclude='.*' . | xargs -I{} bash -c "clear && $0 test && echo 'Test suite completed'"

        ;;

    install)
        # 1. compile the project
        llc coffee.ll > coffee.s
        gcc coffee.s -o coffee

        # 2. move in $PATH output (see install command)
        mkdir -p "$COFFEE_BIN/bin"
        cp coffee syntax.txt "$COFFEE_BIN/bin"
        echo "'coffee' successfully installed!"
        ;;

    build)
        ./run main.bn
        mv out run
        mv debug.ll coffee.ll
        ;;

    prepare)
        "$COFFEE_EXE" main.bn
        mv debug.ll coffee.ll
        ;;

    update)
        # coffee -in main.bn -out run
        "$COFFEE_EXE" main.bn && mv out "$COFFEE_EXE"
        ;;
esac
